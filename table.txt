
----------------------NOT IMPLEMENTED-------------------------------------------

CREATE TABLE registeredVehicle (
  registeredVehicleId INT AUTO_INCREMENT PRIMARY KEY,
  vehicleId INT NOT NULL UNIQUE,       -- one active row per vehicle
  customerId INT NOT NULL,             -- current owner
  registeredAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  CONSTRAINT fk_rv_vehicle FOREIGN KEY (vehicleId) 
      REFERENCES vehicle(vehicleId) ON DELETE CASCADE,
  CONSTRAINT fk_rv_customer FOREIGN KEY (customerId) 
      REFERENCES customers(customerId) ON DELETE CASCADE
);

CREATE TABLE vehicleOwnershipHistory (
  historyId INT AUTO_INCREMENT PRIMARY KEY,
  vehicleId INT NOT NULL,
  customerId INT NOT NULL,
  ownershipStart TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ownershipEnd TIMESTAMP NULL,  -- NULL = current owner
  notes TEXT,

  CONSTRAINT fk_voh_vehicle FOREIGN KEY (vehicleId)
      REFERENCES vehicle(vehicleId) ON DELETE CASCADE,
  CONSTRAINT fk_voh_customer FOREIGN KEY (customerId)
      REFERENCES customers(customerId) ON DELETE CASCADE
);

---------------------------------------------------------
- Slot Date table
CREATE TABLE slotDate (
    slotDateId INT AUTO_INCREMENT PRIMARY KEY,
    slotDate DATE NOT NULL UNIQUE,
    isOpen BOOLEAN DEFAULT TRUE,        -- TRUE=open, FALSE=closed
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Time Slot table
CREATE TABLE timeSlot (
    timeSlotId INT AUTO_INCREMENT PRIMARY KEY,
    slotDateId INT NOT NULL,
    startTime TIME NOT NULL,
    endTime TIME NOT NULL,
    isAvailable BOOLEAN DEFAULT TRUE,   -- TRUE=available, FALSE=booked/closed
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (slotDateId) REFERENCES slotDate(slotDateId) ON DELETE CASCADE
);


-- 1️⃣ Booking Status table
CREATE TABLE bookingStatus (
  id INT AUTO_INCREMENT PRIMARY KEY,
  statusName VARCHAR(50) NOT NULL UNIQUE,
  description VARCHAR(255),
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO bookingStatus (statusName, description) VALUES
('Pending', 'Awaiting admin approval'),
('Confirmed', 'Booking confirmed and scheduled'),
('Completed', 'Consultation finished'),
('Rescheduled', 'Moved to another date/time'),
('Cancelled', 'Booking cancelled'),
('No-Show', 'Customer did not attend');

-- 2️⃣ Booking table
CREATE TABLE booking (
  bookingId INT AUTO_INCREMENT PRIMARY KEY,
  customerId INT NOT NULL,
  technicianId INT DEFAULT NULL,
  timeSlotId INT NOT NULL,
  statusId INT DEFAULT 1, -- Pending
  notes TEXT,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (customerId) REFERENCES customers(customerId) ON DELETE CASCADE,
  FOREIGN KEY (technicianId) REFERENCES technicians(technicianId) ON DELETE SET NULL,
  FOREIGN KEY (timeSlotId) REFERENCES timeSlot(timeSlotId) ON DELETE CASCADE,
  FOREIGN KEY (statusId) REFERENCES bookingStatus(id),

  INDEX idx_customer (customerId),
  INDEX idx_technician (technicianId),
  INDEX idx_status (statusId)
);

CREATE TABLE technicianAvailability (
    technicianAvailabilityId INT AUTO_INCREMENT PRIMARY KEY,
    technicianId INT NOT NULL,
    timeSlotId INT NOT NULL,
    isAvailable BOOLEAN DEFAULT TRUE,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (technicianId) REFERENCES technicians(technicianId) ON DELETE CASCADE,
    FOREIGN KEY (timeSlotId) REFERENCES timeSlot(timeSlotId) ON DELETE CASCADE,
    UNIQUE KEY uniq_tech_slot (technicianId, timeSlotId)
);

-- 3️⃣ Booking History table
CREATE TABLE bookingHistory (
  historyId INT AUTO_INCREMENT PRIMARY KEY,
  bookingId INT NOT NULL,
  statusId INT NOT NULL,
  changedBy INT DEFAULT NULL,  -- refers to users.userId
  remarks TEXT,
  changedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (bookingId) REFERENCES booking(bookingId) ON DELETE CASCADE,
  FOREIGN KEY (statusId) REFERENCES bookingStatus(id),
  FOREIGN KEY (changedBy) REFERENCES users(userId) ON DELETE SET NULL,

  INDEX idx_booking (bookingId),
  INDEX idx_status (statusId),
  INDEX idx_changedBy (changedBy)
);

ALTER TABLE booking ADD COLUMN bookingDate DATE AFTER technicianId;
ALTER TABLE booking
ADD COLUMN bookingDate DATE AFTER technicianId;
DESCRIBE booking;

-- Disable foreign key checks temporarily
SET FOREIGN_KEY_CHECKS = 0;

-- Truncate all related tables
TRUNCATE TABLE bookingHistory;
TRUNCATE TABLE booking;
TRUNCATE TABLE technicianAvailability;
TRUNCATE TABLE timeSlot;
TRUNCATE TABLE slotDate;

-- (Optional) truncate these if you want to reset everything
-- TRUNCATE TABLE customers;
-- TRUNCATE TABLE technicians;
-- TRUNCATE TABLE bookingStatus;

-- Re-enable foreign key checks
SET FOREIGN_KEY_CHECKS = 1;




//====================NEW VEHICLE HISTORY=====================
CREATE TABLE vehicleUser (
  userId INT AUTO_INCREMENT PRIMARY KEY,
  historyId INT NOT NULL,        -- link to vehicleOwnershipHistory
  customerId INT NOT NULL,       -- the person using or managing the vehicle
  relationship VARCHAR(50),      -- e.g., 'Owner', 'Wife', 'Husband', 'Driver'
  isPrimaryUser BOOLEAN DEFAULT FALSE,
  addedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT fk_vu_history FOREIGN KEY (historyId)
      REFERENCES vehicleOwnershipHistory(historyId) ON DELETE CASCADE,
  CONSTRAINT fk_vu_customer FOREIGN KEY (customerId)
      REFERENCES customers(customerId) ON DELETE CASCADE
);



vehicleOwnershipHistory(
  historyId INT PK,
  vehicleId INT,
  customerId INT,      -- Legal owner
  ownershipStart TIMESTAMP,
  ownershipEnd TIMESTAMP,
  ownerSequence INT,   -- 1st, 2nd, etc.
  notes TEXT
)



//----------------------------------------------------

-- =========================================
-- 1️⃣ SERVICE JOB
-- =========================================
CREATE TABLE service_job (
  serviceJobId INT AUTO_INCREMENT PRIMARY KEY,
  currentStage ENUM('Diagnostic','Check-in','Repair','Testing','Completion') DEFAULT 'Diagnostic',
  assignedTechnicianName VARCHAR(100),
  startedAt DATETIME,
  endedAt DATETIME
);

-- =========================================
-- 2️⃣ SERVICE JOB WORKFLOW
-- =========================================
CREATE TABLE service_job_workflow (
  serviceJobWorkFlowId INT AUTO_INCREMENT PRIMARY KEY,
  serviceJobId INT NOT NULL,
  currentStage ENUM('Diagnostic','Check-in','Repair','Testing','Completion'),
  notes TEXT,
  assignedTechnician VARCHAR(100),
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (serviceJobId) REFERENCES service_job(serviceJobId)
    ON DELETE CASCADE
);

-- =========================================
-- 3️⃣ SERVICE HISTORY
-- =========================================
CREATE TABLE service_history (
  serviceHistoryId INT AUTO_INCREMENT PRIMARY KEY,
  carProfileId INT NOT NULL,
  packageName VARCHAR(150),
  services TEXT,
  description TEXT,
  totalCost DOUBLE,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- =========================================
-- 4️⃣ QUOTATION
-- =========================================
CREATE TABLE quotation (
  quotationId INT AUTO_INCREMENT PRIMARY KEY,
  technicianId INT NOT NULL,
  customerId INT NOT NULL,
  laborCost DOUBLE,
  partsCost DOUBLE,
  discount DOUBLE DEFAULT 0,
  totalCost DOUBLE,
  workTimeEstimation INT,
  quote TEXT,
  status ENUM('Pending','Approved','Rejected') DEFAULT 'Pending',
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  approvedAt DATETIME NULL,
  FOREIGN KEY (bookingId) REFERENCES service_job(bookingId)
    ON DELETE CASCADE
);

-- =========================================
-- 5️⃣ SERVICE CONTRACT
-- =========================================
CREATE TABLE service_contract (
  contractId INT AUTO_INCREMENT PRIMARY KEY,
  serviceJobId INT NOT NULL,
  scopeOfServices TEXT,
  responsibilities TEXT,
  duration INT,
  agreementCost DOUBLE,
  termsAndCondition TEXT,
  status ENUM('Pending','Approved','Rejected','Expired') DEFAULT 'Pending',
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  approvedAt DATETIME NULL,
  FOREIGN KEY (serviceJobId) REFERENCES service_job(serviceJobId)
    ON DELETE CASCADE
);


////---------------------
CREATE TABLE billing (
  billingId INT AUTO_INCREMENT PRIMARY KEY,
  quotationId INT,  -- or serviceJobId if preferred
  totalAmount DOUBLE NOT NULL,
  amountPaid DOUBLE DEFAULT 0,
  balance DOUBLE GENERATED ALWAYS AS (totalAmount - amountPaid) STORED,
  paymentStatus ENUM('Paid', 'Partial', 'No Payment') DEFAULT 'No Payment',
  billingDate DATE DEFAULT (CURRENT_DATE),
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (quotationId) REFERENCES quotation(quotationId)
    ON DELETE SET NULL
);

CREATE TABLE payment (
  paymentId INT AUTO_INCREMENT PRIMARY KEY,
  billingId INT NOT NULL,
  amountPaid DOUBLE NOT NULL,
  paymentDate DATE DEFAULT (CURRENT_DATE),
  balance DOUBLE DEFAULT 0,
  paymentMethod ENUM('Cash', 'GCash', 'Card', 'Credit', 'Online Transfer', 'Check') DEFAULT 'Cash',
  remarks TEXT,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (billingId) REFERENCES billing(billingId)
    ON DELETE CASCADE
);
